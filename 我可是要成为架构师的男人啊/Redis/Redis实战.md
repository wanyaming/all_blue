## Redis实战

### 数据库

#### 数据库结构

```c
typedef struct redisDb {
    // ...
    // 保存所有的键值对
    dict *dict;
    // 过期字典，保存着键的过期时间
    dict *expires
    // ...
}
```

有多个db，可以通过select 显示切换。

#### 过期键删除策略



![过期键的结构]( https://i.bmp.ovh/imgs/2019/10/818c105ccba15966.png )

* 定时删除

  设置键的同时，创建一个定时器，自动触发删除任务

* 惰性删除

  放任键过期不管，操作的时候再校验

* 定期删除

  定时任务，分多次从数据库的expires字典中随机检查一部分键的过期时间，删除过期键；

  记录每次的进度，分次完成。

实际使用的是惰性删除配合定期删除

### AOF、RDB和复制功能对过期键的处理

* RDB

  执行SAVE或BGSAVE时，会忽略过期键；

  载入RDB，如果是主服务器，忽略过期键；如果是从服务器，不做处理

* AOF

  数据库中包含的过期键无影响

* 复制

  主服务器删除过期键，从服务器接收删除命令

---

### RDB持久化

* SAVE

  阻塞Redis服务器进程，知道RDB文件创建完毕

* BGSAVE

  派生出一个子进程，负责RDB的创建，服务器进程（父进程）继续处理命令请求；

  与AOF的BGREWRITEAOF不能同时执行

Redis服务器在启动是检测到RDB文件存在，会自动载入，并处于阻塞状态，知道载入完成。

**RDB文件结构**

| REDIS  | db_version | databases 0      | database 11 | EOF      | check_sum    |
| ------ | ---------- | ---------------- | ----------- | -------- | ------------ |
| 文件头 | 文件版本号 | 多个数据库的数据 |             | 结束标志 | 文件校验比对 |

---

### AOF持久化

* 命令追加(append)

  服务器执行完写命令后，追加一条修改日志

* 文件写入于同步

  将aof_buf缓冲区的日志写入到AOF文件，写入频率有`always`（每次同步）、`everysec`（每秒同步）、`no`（由系统决定）

如果要从AOF中还原，会先创建一个不带网络的伪客户端，然后回放写命令。

**AOF重写**

查出数据库当前的状态，记录成一条日志

**BGREWRITEAOF**

* 创建子进程来进行AOF重写
* 期间主进程执行完写命令会同时往AOF缓冲区和AOF重写缓冲区发日志
* 子进程完成AOF重写工作后，向父进程发送一个信号
* 父进程将AOF重写缓冲区的内容写入新AOF
* 替换老的AOF文件

 ![AOF后台重写](https://i.bmp.ovh/imgs/2019/10/7b8ac9d031043316.png) 